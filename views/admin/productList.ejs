<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Apollo Dashboard</title>
        <meta http-equiv="x-ua-compatible" content="ie=edge" />
        <meta name="description" content="" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta property="og:title" content="" />
        <meta property="og:type" content="" />
        <meta property="og:url" content="" />
        <meta property="og:image" content="" />
        <!-- Favicon -->
        <!-- <link rel="shortcut icon" type="image/x-icon" href="/admin/imgs/theme/favicon.svg" /> -->
        <!-- Template CSS -->
        <link href="/admin/css/main.css?v=1.1" rel="stylesheet" type="text/css" />
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    </head>

    <body>
        <div class="screen-overlay"></div>
        <aside class="navbar-aside" id="offcanvas_aside">
            <div class="aside-top">
                <a href="/admin/dashboard" class="brand-wrap">
                    <h4 style="color:#3b5d50 ;">Apollo <br> Furniture.</h4>
                    <!-- <img src="/admin/imgs/theme/logo.svg" class="logo" alt="Nest Dashboard" /> -->

                </a>
                <div>
                    <button class="btn btn-icon btn-aside-minimize"><i class="text-muted material-icons md-menu_open"></i></button>
                </div>
            </div>
            <nav>
                <ul class="menu-aside">
                    <li class="menu-item">
                        <a class="menu-link" href="/admin/dashboard">
                            <i class="icon material-icons md-home"></i>
                            <span class="text">Dashboard</span>
                        </a>
                    </li>
                   
                    <li class="menu-item has-submenu">
                        <li class="menu-item active">
                        <a class="menu-link" href="#">
                            <i class="icon material-icons md-shopping_bag"></i>
                            <span class="text">Products</span>
                        </a>
                        <div class="submenu">
                            <a href="/admin/productList">Product List</a>
                            <a href="/admin/addProducts">Add Products</a>
                            
                        </div>
                    </li>
                    </li>

                        <a class="menu-link" href="/admin/category">
                            <i class="icon material-icons md-add_box"></i>
                            <span class="text"> Category</span>
                        </a>


                        <a class="menu-link" href="/admin/users">
                            <i class="icon material-icons md-person"></i>
                            <span class="text"> Users</span>
                        </a>

                        <a class="menu-link" href="/admin/orders">
                            <i class="icon material-icons md-shopping_cart"></i>
                            <span class="text">Orders</span>
                        </a>

                        <a class="menu-link" href="/admin/coupon">
                            <i class="bi bi-ticket-perforated-fill">
                                <span class="text">Coupon</span></i>
                            
                        </a>

                        <a class="menu-link" href="/admin/offer">
                            <i class="bi bi-percent" style="font-size: 15px;">
                                <span class="text">Offer</span></i>
                            
                        </a>
                       
            </nav>
        </aside>

       
        <main class="main-wrap">
           
            <section class="content-main">
                <div class="content-header">
                    <div>
                        <h2 class="content-title card-title">Products List</h2>
                    </div>
                    <div>
                        
                        <a href="/admin/addProducts" class="btn btn-primary btn-sm rounded">Add Products</a>
                    </div>
                </div>
                <div class="card mb-4" id="reload">
                    <header class="card-header">
                        <div class="row align-items-center">
                            <div class="col col-check flex-grow-0">
                                <div class="form-check ms-2">
                                    <input class="form-check-input" type="checkbox" value="" />
                                </div>
                            </div>
                            <div class="col-md-3 col-12 me-auto mb-md-0 mb-3">
                                <select class="form-select">
                                    <option selected>All category</option>
                                    <% for (let i=0;i<category.length;i++) { %>
                                        <% if(category[i].is_Listed==true){ %>
                                          
                                                  <option value="<%= category[i].name %>">
                                                    <%= category[i].name %>
                                                  </option>
                                                      
                                                
                                          <% } %>
                                          <% } %>
                                </select>
                            </div>
                            <div class="col-md-2 col-6">
                                <input type="date" value="02.05.2021" class="form-control" />
                            </div>
                            <div class="col-md-2 col-6">
                                <select class="form-select">
                                    <option selected>Status</option>
                                    <option>Active</option>
                                    <option>Disabled</option>
                                    <option>Show all</option>
                                </select>
                            </div>
                        </div>
                    </header>
                    <!-- card-header end// -->

                    <% for(let i=products.length-1;i>=0;i--){ %>
                        
                    
                    <div class="card-body">
                        <article class="itemlist">
                            <div class="row align-items-center">
                                <div class="col col-check flex-grow-0">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" />
                                    </div>
                                </div>
                                <div class="col-lg-4 col-sm-4 col-8 flex-grow-1 col-name">
                                    <a class="itemside" href="#">
                                        <div class="left">
                                            <img src="<%= products[i].images[0] %>" class="img-sm img-thumbnail" alt="Item" />
                                        </div>
                                        <div class="info">
                                            <h6 class="mb-0"><span><%= products[i].brand %> - </span><%= products[i].name %></h6>
                                        </div>
                                    </a>
                                </div>
                                <div class="col-lg-2 col-sm-2 col-4 col-price"><span>â‚¹<%= products[i].price %>.00</span></div>
                                
                                <div class="col-lg-1 col-sm-2 col-4 col-date">
                                    <span><%= products[i].quantity %>nos</span>
                                </div>

                                <div class="col-lg-1 col-sm-2 col-4 col-date">
                                    <% if(products[i].isListed === true){ %>
                                    <a href="/admin/unListProduct?id=<%= products[i]._id %>" class="btn font-sm btn-danger" id="unlistbtn" > Unlist </a>
                                    <% }else{ %>
                                        <a href="/admin/listProduct?id=<%= products[i]._id %>" class="btn font-sm btn-primary" id="unlistbtn" > List </a>
                                    <% } %>
                                </div>

                                
                                <div class="col-lg-1 col-sm-2 col-4 col-offer">
                                    <% if(products[i].offer===null){ %>
                                    <button type="button" class="btn btn-warning btn-sm font-sm offerbtn" data-toggle="modal" data-target="#offerModal" data-productid="<%= products[i]._id %>">
                                        Add offer
                                      </button>
                                      <% }else{ %>
                                        <button type="button" class="btn btn-danger btn-sm font-sm" onclick="removeProductOffer(event,'<%= products[i]._id %>')">
                                            Remove offer
                                          </button>
                                        <% } %>
                                </div>
                            

                               
                                

                                <div class="col-lg-2 col-sm-2 col-4 col-action text-end">
                                    
                                    <a href="/admin/editProduct?id=<%= products[i]._id %>" class="btn btn-sm font-sm rounded btn-brand"> <i class="material-icons md-edit"></i> Edit </a>
                                    <br>
                                    <!-- <a href="/admin/deleteProduct?id=<%= products[i]._id %>" class="btn btn-sm font-sm btn-light rounded" onclick="deleteProduct()"> <i class="material-icons md-delete_forever" ></i> Delete </a> -->
                                    <a href="javascript:void(0);" class="btn btn-sm font-sm btn-light rounded" onclick="deleteProduct('<%= products[i]._id %>')">
                                        <i class="material-icons md-delete_forever"></i> Delete
                                    </a>
                                </div>
                            </div>
                            
                            <!-- row .// -->
                        </article>
                        
                        
                    </div>
                    <!-- card-body end// -->
                    <% } %>
                </div>

                <div class="modal fade" id="offerModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="exampleModalLabel">Select Offer</h5>
                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                          </button>
                        </div>
                        <div class="modal-body">
                            <% if(offer && offer.length > 0) { %>
                              <ul class="list-group">
                                <% offer.forEach((offerItem)=> { %>
                                  <li class="list-group-item">
                                    <div>
                                      <h6><%= offerItem.offerName %></h6>
                                      <p>Starting Date: <%= offerItem.startingDate.toLocaleDateString() %></p>
                                      <p>Expiry Date: <%= offerItem.expiryDate.toLocaleDateString() %></p>
                                      
                                      <a href="#" class="btn btn-warning btn-sm" onclick="applyOffer(event,'<%= offerItem._id %>')">Apply</a>
                                    </div>
                                  </li>
                                <% }) %>
                              </ul>
                            <% } else { %>
                              <p>No offers available.</p>
                            <% } %>
                          </div>
                          
                        <!-- <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                          <button type="button" class="btn btn-primary">Save changes</button>
                        </div> -->
                      </div>
                    </div>
                  </div>
                
                <!-- card end// -->
                <!-- <div class="pagination-area mt-30 mb-50">
                    <nav aria-label="Page navigation example">
                        <ul class="pagination justify-content-start">
                            <li class="page-item active"><a class="page-link" href="#">01</a></li>
                            <li class="page-item"><a class="page-link" href="#">02</a></li>
                            <li class="page-item"><a class="page-link" href="#">03</a></li>
                            <li class="page-item"><a class="page-link dot" href="#">...</a></li>
                            <li class="page-item"><a class="page-link" href="#">16</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#"><i class="material-icons md-chevron_right"></i></a>
                            </li>
                        </ul>
                    </nav>
                </div> -->
            </section>
            <!-- content-main end// -->
            <footer class="main-footer font-xs">
                <div class="row pb-30 pt-15">
                    <div class="col-sm-6">
                        <script>
                            document.write(new Date().getFullYear());
                        </script>
                        &copy; Nest - HTML Ecommerce Template .
                    </div>
                    <div class="col-sm-6">
                        <div class="text-sm-end">All rights reserved</div>
                    </div>
                </div>
            </footer>
        </main>


        <script>

            //list product


            function unListProduct(event,productId){
                
                event.preventDefault()
                let unlistbtn = $('#unlistbtn')
                if(unlistbtn.text() === 'Unlist'){
                Swal.fire({
            title: 'Are you sure?',
            text: 'Want to unlist the product',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#DD6B55',
            confirmButtonText: 'Yes, Unlist it!',
            cancelButtonText: 'Cancel'
        }).then((result)=>{
            if(result.isConfirmed){
               let unlistbtn =  $('#unlistbtn')
               unlistbtn.text = 'List'
               unlistbtn.removeClass("btn-danger").addClass("btn-primary");
                fetch(`/admin/unListProduct?id=${productId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                // Add any additional headers if needed
            },
            
        })
               



            }
        }).then(response => {
            console.log('res:',response);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
               
            }
                return response.json(); 
            
            // If the server returns JSON, you can parse it
        })
        
        .then(data => {
            console.log('Product deleted successfully:', data);
            Swal.fire({
  
  icon: "success",
  title: "Product unlisted successfully",
  showConfirmButton: false
});
            setTimeout(()=>{
                window.location.href = '/admin/productList'; 
                
            },1000)
            
                
            // Handle success (e.g., update UI)
        })
        .catch(error => {
            console.error('Error deleting product:', error);
            Swal.fire('Error!', 'Failed to delete the product.', 'error');
            // Handle errors (e.g., show an error message)
        });
    }

    }







             function deleteProduct(productId) {
        // Display confirmation modal (if needed)

        Swal.fire({
            title: 'Are you sure?',
            text: 'You will not be able to recover this product!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#DD6B55',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result)=>{
            if(result.isConfirmed){
                fetch(`/admin/deleteProduct?id=${productId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                // Add any additional headers if needed
            },
        }).then(response => {
            console.log('res:',response);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
               
            }
                return response.json(); 
            
            // If the server returns JSON, you can parse it
        })
            }
        })
        .then(data => {
            console.log('Product deleted successfully:', data);
            Swal.fire({
  
  icon: "success",
  title: "Product Deleted Successfully",
  showConfirmButton: false
});
            setTimeout(()=>{
                window.location.href = '/admin/productList'; 
                
            },1000)
            
                
            // Handle success (e.g., update UI)
        })
        .catch(error => {
            console.error('Error deleting product:', error);
            Swal.fire('Error!', 'Failed to delete the product.', 'error');
            // Handle errors (e.g., show an error message)
        });

        
        
        
    }




    $('#offerModal').on('shown.bs.modal', function (e) {
    var productId = $(e.relatedTarget).data('productid');
    $('#offerModal').data('productId', productId);
});
    



    function applyOffer(event,offerId){
        event.preventDefault()
        var productId = $('#offerModal').data('productId');
        $.ajax({
            url:'/admin/addProductOffer',
            method:'post',
            data:{offerId,productId},
            success:((response)=>{
                if(response.success){
                    Swal.fire({
            title: 'Success!',
            text: 'Offer added successfully',
             icon: 'success',
            confirmButtonText: 'OK',
            }).then((result)=>{
                if(result.isConfirmed){
                    $('#offerModal').modal('hide');
                    window.location.reload()
                }
            })
                }else{
                    Swal.fire({
  icon: "error",
  title: "Oops...",
  text: "Something went wrong!",
});
                }
            })
        })

    }



    //remove offer from product


    function removeProductOffer(event, productId) {
    event.preventDefault();
    $.ajax({
        url: '/admin/removeProductOffer',
        method: 'post',
        data: { productId },
        success: function(response) { 
            if (response.success) {
                Swal.fire({
                    title: 'Success!',
                    text: 'Offer Removed successfully',
                    icon: 'success',
                    confirmButtonText: 'OK',
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.reload();
                    }
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Something went wrong!',
                });
            }
        }
    });
}




    
        </script>
        <script src="assets/js/vendors/jquery-3.6.0.min.js"></script>
        <script src="assets/js/vendors/bootstrap.bundle.min.js"></script>
        <script src="assets/js/vendors/select2.min.js"></script>
        <script src="assets/js/vendors/perfect-scrollbar.js"></script>
        <script src="assets/js/vendors/jquery.fullscreen.min.js"></script>
        <!-- Main Script -->
        <script src="assets/js/main.js" type="text/javascript"></script>
    </body>
</html>
